# nginx 介绍

> nginx 是一款轻量级的 http 服务器，使用 事件驱动的异步非阻塞 处理方式框架，具有较好的 IO 性能，时常用作服务端的反向代理和负载均衡。参考自：[https://juejin.cn/post/6844903684967825421](https://juejin.cn/post/6844903684967825421)

nginx 发布于 2004 年，到现在，几乎所有的大型网站都搭建在 nginx 之上，已然成为互联网网站搭建的必选技术之一。

nginx 的一些标签，http 服务器、事件驱动、异步非阻塞等等，是不是跟 nodeJS 很像，所以一些同学可能会认为，直接用 nodeJs 不就可以了嘛，为啥还用 nginx？的确，nginx 和 nodejs 很像，但是他们也并不冲突呀，nginx 因为内部封装了很多逻辑，所以对底层服务端资源的处理比较擅长（比如：静态资源转发、负载均衡、反向代理），而 nodejs 则是对上层具体逻辑的处理更加擅长。两者可以实现完美的结合，共同助力前端开发。

nginx 的各种配置水很深，看似很简单，但是往往对于同一个功能，不同的配置方式，效率可能会差上好几倍。这些往往是建立在对 nginx 的深入理解和常年的配置运维经验上。

### 正向代理和反向代理

首先，代理即使在 client 端和 server 端之间增加一层提供特定服务的服务器，即代理服务器。

- **正向代理**。正向代理中 client 端和代理服务器是在同一个 LAN 下，可以直接互相访问，所以正向代理代理的是 client。翻墙工具就是一个正向代理，他会把访问墙外 server 的 client 请求，代理到可以访问墙外服务的 proxy 服务器，然后 proxy 服务器再把访问到的墙外 server 的返回结果，转发给 client
- **反向代理**。反向代理中 server 端和代理服务器是在同一个 LAN 下，可以直接互相访问，所以反向代理代理的是 server。负载均衡就是一个反向代理的应用，所有到 server 的请求，都会代理到 proxy 服务器，至于内网真正访问的是哪个服务器，由 proxy 决定。

#### 反向代理的好处

- 安全及权限。使用反向代理后，client 端将无法直接通过请求访问真正的服务器，必须先通过 nginx，可以通过在 nginx 上将危险和没有权限的请求过滤掉，从而保证服务器的安全
- 负载均衡。比如一个网站的服务被部署在很多服务器上，这些服务器可以看作一个集群，那么 nginx 就可以将接收到的 client 请求，均匀的分配到这个集群中的所有服务器上，从而实现服务器压力的负载均衡。（nginx 内置多种负载均衡算法）
  > nginx 自带的还有心跳检查，会定期向所有服务器发送健康检查请求，一旦发现某台服务器处于异常状态，那么接下来的 client 请求就不会被发送到该服务器上，直至后面健康检查发现服务器正常，从而保证客户端访问的稳定性。

### 前端可以用 nginx 做什么

- 快速实现简单的访问控制

  - 可以控制某个网站只对指定 ip（段）开发，其他 ip 无法访问

    ```nginx
        location / {
            deny  192.168.1.100;
            allow 192.168.1.10/200;
            allow 10.110.50.16;
            deny  all;
        }
    ```

    上述配置意思是，首先禁止 192.168.1.100 访问，然后允许 192.168.1.10-200ip 段（排除 100）访问，同时允许 10.110.50.16 访问，其他剩下的 ip 全部禁止访问。deny/allow 功能的实现采用的是 ngx_http_geo_module 模块

- 解决跨域
  - nginx 解决跨域是通过反向代理的形式，首先 proxy 和 server 在同一 LAN 下，可以正常通信，然后 proxy 服务器通过配置 header 支持浏览器过来的接口请求，这样 client 通过 proxy 就可以请求 server 上的服务。
- 适配 pc 和移动环境

  - nginx 可以通过内置变量\$http_user_agent，获取到请求客户端的 userAgent，从而知道用户处于移动端还是 PC，进而控制重定向到 H5 还是 PC 站

    ```nginx
        location / {
            # 移动、pc设备适配
            if ($http_user_agent ~* '(Android|webOS|iPhone|iPod|BlackBerry)') {
                set $mobile_request '1';
            }
            if ($mobile_request = '1') {
                rewrite ^.+ http://mysite-base-H5.com;
            }
        }
    ```

- 合并请求
  - nginx 可以通过 nginx-http-concat（淘宝开发的第三方模块，需要单独安装），以一种特殊的 url 规则，将多个资源的请求合并成一个请求，后台 nginx 会获取各个资源并拼接成一个结果进行返回。（例如这个 url：example.com/??1.js,2.js,3.js，就会将 1.js,2.js,3.js 这三个 js 文件合并成一个 js 文件返回）
- 图片处理
  - nginx 可以通过 ngx_http_image_filter_module（第三方模块，需要单独安装），可以搭建出一个图片处理服务，支持通过 url 参数来控制图片的裁剪/缩放/旋转/图片品质等需求。这里图片处理一般还会加上 nginx 缓存的配置，避免每次请求重新处理图片，减小服务端压力。还可以通过和 nginx-upload-module 一起使用，加入图片上传的功能
- 页面内容修改
