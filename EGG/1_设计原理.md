# 服务端框架的演进

> (参考链接：[https://juejin.cn/post/6844903608706678797](https://juejin.cn/post/6844903608706678797))

### 有赞 node 框架的演进过程

- Koa + 中间件。把项目快速搭起来，选一个简单无风险的项目正式投入生产，把该踩的坑都踩一踩
- 脚手架项目模版。将上一个项目进行整理，抽离出一个项目模版，新项目只需要把这个项目克隆一下，改改配置，就可以快速打一个项目出来
- 阿童木 1.0。项目多了以后，脚手架的方式弊端就逐渐体现出来，因为模版代码和业务代码是强耦合的，如果要更新模版代码的话，就需要在所有项目中手动更新。而且随着时间推移，每个项目的目录结构和代码风格也会变的非常不一样，所以**解耦框架代码和业务代码就非常重要**。所以，我们在脚手架模版的基础之上抽离出了一个框架叫 Astroboy（阿童木），这个框架是在 koa 基础之上封装的，这样每个项目给予该框架进行开发，如果框架更新了，只需要项目中更新一下框架版本号即可
- 阿童木 2.0。使用的项目多了，又有了新问题，因为每个项目的业务场景都不一样，对框架的需求也都不一样，比如某个中间件，项目 A 需要，但项目 B 不需要，此时的框架还不支持定制改造。所以基于此，我们对框架又进行了大的重构：（这些点和 eggjs 的特性就很像）
  - 基于 koa2 开发，性能更优异
  - 提供基于 Astroboy 定制上层框架的能力
  - 高度可扩展的插件机制
  - 渐进式开发

### 框架组成的几个核心概念

### 应用 Application

### 框架 Framework

### 插件 Plugin

插件化是软件设计中的一个重要思想，它可以让我们的系统解耦，每个模块做到单独开发，而且模块之间不会相互影响，这种特性对大型项目来说非常重要。

插件化是 Astroboy 2.0 框架中最核心的一个实现，他是服务、中间件、工具函数库等的载体。本质上还是 NPM 包，只不过在 NPM 包基础之上做了更深层次的抽象。插件约定了目录结构，每个插件看起来都是类似的，这对于团队协作非常重要。插件是在应用启动后自动注入到整个应用中的，如果需要使用的话，只需要在插件的配置文件中开启即可。

# 服务端框架接入服务化体系的历程

随着公司业务的发展，网站规模越来越大，垂直应用越来越多，应用之间的交互不可避免。这时将核心业务抽取出来，作为独立的服务，逐渐形成稳定的服务中心，使前端应用能更快速的响应市场需求。

基于此，分布式服务架构（RPC）就势在必行了，他可以提高业务的复用和整合。

### 技术栈的选择 （node 还是 java 之类的服务端语言选择）

- 生态是否健全，各种配套工具、开源软件是否齐全
- 能否快速招到对口的人

### 服务化之后每一层的职责

node 一层不会处理过多的业务逻辑，具体的业务逻辑还是要使用 java，node 主要负责这三件事：

- 模版文件渲染，做 SSR
- BFF，做数据的聚合，一些复杂的页面，往往需要请求多个接口才能显示完整的页面，这时就用 node 去聚合多个接口的结果，将合并后的数据返回
- 做转发，java 的接口一般不会暴露到公网给前端使用，所以这种情况下，node 需要承担接口转发的角色

java 主要处理业务逻辑、缓存这些复杂的操作

### node 如何调用 java 的服务

java 的分布式服务架构使用了阿里开源的 dubbo，该框架支持以添加注解的方式生成 restful api。

# 分布式架构

> 参考链接：[https://blog.csdn.net/l6108003/article/details/94835586](https://blog.csdn.net/l6108003/article/details/94835586)

### 分布式的概念

分工协作，专人做专事

### 分布式的高可用设计

分布式架构中往往 高可用、一致性 这两个特性往往不能同时满足，所以我们要视具体业务去取用。

对于数据展示这种，用户宁可获取到旧数据，也不愿意等半天才打开应用这种场景，往往是保证高可用，让数据达到最终一致性。

如何设计高可用的分布式架构呢，主要是以下几个方面：

- 搭建服务集群，提高负载，避免单点故障 （访问量较多或核心服务，核心服务指一旦挂掉整个应用都不可用的服务）
- 搭建异地备灾，预防某地因为地震、台风之类自然灾害导致集群服务器都不可用的情况
- 接口限流及服务降级，为防止过高的并发量造成的服务器负载过高而出现故障，应对接口限流。同时当某个服务或多个服务出现故障时，应对该服务进行降级，避免拖累整个应用。比如支付因为网络原因导致无法支付时，搜索和下单仍然可用
- 故障监控报警
- 服务的可伸缩性，易于水平扩张服务器数量
- 使用缓存降低服务器压力
- 使用 CDN 等，加速静态资源访问

### 分布式架构的演化过程

- 单机版
- 应用服务器和数据库服务器分离
- 搭建应用服务器集群
- 数据库读写分离
- 数据库水平或垂直拆分
- 应用拆分
